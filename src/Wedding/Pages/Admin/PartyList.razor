@page "/parties"
@using BlazorDownloadFile;
@using System.Net;
@using Wedding.Services
@using System.IO
@using System.Net.Http
@using System.Net.Http.Headers
@inject IPartyService partyService
@inject IDialogService dialogService
@inject IJSRuntime _js
@inject NavigationManager _navigation
@inject NavigationManager NavigationManager
@inject HttpClient _http
@inject IBlazorDownloadFileService _downloadService

<AuthorizeView>
    <Authorized>
        <MudGrid Justify="Justify.FlexEnd">

            <MudItem xs="6">
                <MudFileUpload T="IBrowserFile" FilesChanged="UploadGuests" Accept=".xlsx">
                    <ButtonTemplate Context="buttonContext">
                        <MudButton HtmlTag="label" Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.CloudUpload" for="@buttonContext">
                            Upload Guests
                        </MudButton>
                    </ButtonTemplate>
                </MudFileUpload>
            </MudItem>

            <MudItem xs="6">
                <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.CloudDownload" OnClick="DownloadGuests">
                    Download Guests
                </MudButton>
                <MudProgressCircular Indeterminate="false" Visible="@IsLoading" />
            </MudItem>

        </MudGrid>

        <MudTable Items="@parties" Hover="true" Dense="true">
            <ToolBarContent>
                <MudText Typo="Typo.h6">Parties</MudText>
                <MudSpacer/>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@AddParty">Add Party</MudButton>
            </ToolBarContent>
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Address</MudTh>
                <MudTh>Comments</MudTh>
                <MudTh>Invited</MudTh>
                <MudTh>Sent</MudTh>
                <MudTh>Actions</MudTh>
                <MudTh>Invite Id</MudTh>
            </HeaderContent>
            <RowTemplate Context="party">
                <MudTd DataLabel="Name">@party.PartyName</MudTd>
                <MudTd DataLabel="Address">@party.Address</MudTd>
                <MudTd DataLabel="Comments">@party.Comments</MudTd>
                <MudTd DataLabel="Invited">
                    <MudSwitch Checked="@party.IsInvited" Disabled="true"/>
                </MudTd>
                <MudTd DataLabel="Sent">
                    <MudSwitch Checked="@party.InvitationSent" Disabled="true"/>
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="@(() => EditParty(party))">Edit</MudButton>
                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteParty(party))">Delete</MudButton>
                    <NavLink href="@($"/guests/{party.PartyId}")">
                        <MudButton Variant="Variant.Outlined" Color="Color.Default" Size="Size.Small">Guests</MudButton>
                    </NavLink>
                </MudTd>
                <MudTd DataLabel="Invite Id">
                    <MudLink href="@($"/qrcodes/{party.UniqueInviteId}.png")">@party.UniqueInviteId</MudLink>
                    </MudTd>
            </RowTemplate>
        </MudTable>
    </Authorized>
</AuthorizeView>

@code {
    private List<Party> parties;
    private bool Busy = false;
    private bool IsLoading = false;

    protected override async Task OnInitializedAsync()
    {
        Busy = true;

        try
        {
            parties = await partyService.GetAllAsync();
        }
        finally
        {
            Busy = false;
        }
        await base.OnInitializedAsync();
    }

    private async Task AddParty()
    {
        var dialog = dialogService.Show<PartyForm>("Add Party");
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            var party = (Party)result.Data;
            await partyService.AddAsync(party);
            parties.Add(party);
            StateHasChanged();
        }
    }

    private async Task EditParty(Party party)
    {
        var dialog = dialogService.Show<PartyForm>("Edit Party", new DialogParameters { ["Party"] = party });
        var result = await dialog.Result;
        if (!result.Cancelled)
        {
            var updatedParty = (Party)result.Data;
            await partyService.UpdateAsync(updatedParty);
            var index = parties.IndexOf(party);
            parties[index] = updatedParty;
            StateHasChanged();
        }
    }

    private async Task DeleteParty(Party party)
    {
        bool? result = await dialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete {party.PartyName}?",
            yesText: "Delete", cancelText: "Cancel");
        if (result == true)
        {
            await partyService.DeleteAsync(party);
            parties.Remove(party);
            StateHasChanged();
        }
    }

    private async Task UploadGuests(IBrowserFile file)
    {
        IsLoading = true;
        // Read the file content as a byte array
        //var fileContent = await file.OpenReadStream().ReadAsync();
        // Your logic to process the excel file and upload the data
        // ...
        IsLoading = false;
    }

    private async Task DownloadGuests()
    {
        IsLoading = true;

        var cookie = await _js.InvokeAsync<string>("getCookie", ".AspNetCore.Identity.Application");
        var token = await _js.InvokeAsync<string>("localStorage.getItem", "authToken");
        // Set the cookie or token to the HttpClient request header
        if (!string.IsNullOrEmpty(cookie))
        {
            _http.DefaultRequestHeaders.Add("Cookie", cookie);
        }
        if (!string.IsNullOrEmpty(token))
        {
            _http.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", token);
        }

        var response = await _http.GetAsync("api/getguestlist");

        var bytes = await response.Content.ReadAsByteArrayAsync();
        // Stream the file content to a raw binary data buffer on the client
        var now = DateTime.UtcNow.ToString();
        await _js.InvokeVoidAsync("downloadFileFromStream", bytes, $"guests-{now}.xlsx");
        
        IsLoading = false;
    }
}